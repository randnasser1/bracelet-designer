<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jewelry Designer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background: #ffe6f0;
      color: #333;
      margin: 0;
      padding: 1rem;
    }

    h1, h2, h3 {
      color: #d6336c;
      margin-bottom: 1rem;
      text-align: center;
    }

    .main-content {
      max-width: 1000px;
      margin: 0 auto;
    }

    .product-selector {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .product-btn {
      background: #ff85b3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .product-btn.active {
      background: #d6336c;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #d6336c;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .control-group {
      background: rgba(255, 255, 255, 0.7);
      padding: 0.6rem;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .btn {
      background: #ff85b3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .btn:hover {
      background: #ff5fa3;
    }

    .download-btn {
      background: #4CAF50;
    }

    .order-btn {
      background: #d6336c;
    }

    .bracelet-container {
      width: 100%;
      overflow-x: auto;
      padding-bottom: 10px;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    #jewelry-piece {
      display: flex;
      gap: 8px;
      padding: 1rem;
      border: 2px dashed #f5a0c2;
      border-radius: 16px;
      background: #fff0f5;
      min-height: 80px;
      width: max-content;
      min-width: 100%;
    }

    .bracelet-container::-webkit-scrollbar {
      height: 6px;
    }

    .bracelet-container::-webkit-scrollbar-track {
      background: #fff0f5;
      border-radius: 3px;
    }

    .bracelet-container::-webkit-scrollbar-thumb {
      background: #ff85b3;
      border-radius: 3px;
    }

    .slot {
      flex: 0 0 50px;
      height: 50px;
      border: 2px dashed #f5a0c2;
      border-radius: 10px;
      background: rgba(255, 160, 195, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
    }

    .slot:empty::after {
      content: "+";
      position: absolute;
      color: #d6336c;
      font-size: 1.2rem;
      opacity: 0.5;
    }

    .slot img {
      width: 42px;
      height: 42px;
      object-fit: contain;
    }

    .price-display {
      font-size: 1.1rem;
      font-weight: 600;
      color: #d6336c;
      margin: 0.5rem 0;
      text-align: center;
    }

    .charm-pools {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .charm-pool {
      background: #fff0f5;
      border: 1px solid #f5a0c2;
      border-radius: 16px;
      padding: 0.8rem;
    }

    .charm-pool h3 {
      color: #a61e4d;
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .charms-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .charm {
      width: 45px;
      height: 45px;
      cursor: pointer;
      transition: transform 0.2s;
      object-fit: contain;
      position: relative;
    }

    .charm:hover {
      transform: scale(1.1);
    }

    .special {
      border: 2px solid #ff85b3;
      border-radius: 8px;
    }

    .rare {
      border: 2px solid purple;
      border-radius: 8px;
    }

    .charm.sold-out {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .charm.used {
      position: relative;
    }

    .charm.used::after {
      content: "✓";
      position: absolute;
      top: -8px;
      right: -8px;
      background: #d6336c;
      color: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .sold-out-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(214, 51, 108, 0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .pricing-info {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      margin: 1rem auto;
      max-width: 600px;
    }

    .pricing-info h3 {
      color: #d6336c;
      margin-top: 0;
      font-size: 1rem;
      text-align: center;
    }

    .pricing-info ul {
      padding-left: 1.2rem;
      margin: 0.5rem 0;
    }

    .pricing-info li {
      margin-bottom: 0.3rem;
      line-height: 1.3;
    }

    .highlight {
      color: #d6336c;
      font-weight: 600;
    }

    .selected {
      box-shadow: 0 0 0 3px #d6336c;
    }

    .material-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .material-option {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      font-size: 0.8rem;
    }

    .material-option.selected {
      border-color: #d6336c;
      background: rgba(214, 51, 108, 0.1);
    }

    .material-option.silver {
      background: #e0e0e0;
    }

    .material-option.gold {
      background: linear-gradient(135deg, #ffd700, #daa520);
    }

    .material-option.mix {
      background: linear-gradient(135deg, #e0e0e0 50%, #ffd700 50%);
    }

    /* Order Form Styles */
    .order-form {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem auto;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #d6336c;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #f5a0c2;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
    }
    
    .payment-options {
      margin: 1rem 0;
    }
    
    .payment-option {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .payment-option input {
      margin-right: 0.5rem;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      width: 100%;
      text-align: center;
    }
    
    .order-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      padding: 8px 16px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    
    .modal-btn.confirm {
      background-color: #d6336c;
      color: white;
    }
    
    .modal-btn.cancel {
      background-color: #e0e0e0;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1rem 0;
    }

    @media (max-width: 480px) {
      .slot {
        flex: 0 0 45px;
        height: 45px;
      }
      .slot img {
        width: 38px;
        height: 38px;
      }
      #jewelry-piece {
        padding: 0.8rem;
        gap: 6px;
      }
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <h1>Jewelry Designer</h1>
    
    <div class="product-selector">
      <button class="product-btn active" data-type="bracelet">Bracelet</button>
      <button class="product-btn" data-type="anklet">Anklet</button>
      <button class="product-btn" data-type="necklace">Necklace</button>
    </div>

    <div class="controls">
      <div class="control-group">
        <span>Material:</span>
        <div class="material-selector">
          <div class="material-option silver selected" data-material="silver">Silver</div>
          <div class="material-option gold" data-material="gold">Gold (+1 JD)</div>
          <div class="material-option mix" data-material="mix">Mix (+2.5 JDs)</div>
        </div>
      </div>
      <div class="control-group">
        <button class="btn" id="full-glam-btn">Full Glam Look</button>
      </div>
    </div>

    <div class="bracelet-container">
      <div id="jewelry-piece"></div>
    </div>

    <div class="price-display">
      <div id="base-price">Base Price: 10 JDs</div>
      <div id="charm-price">Charms: 0 JDs (0/2 free specials used)</div>
      <div id="total-price">Total: 10 JDs</div>
    </div>

    <div class="action-buttons">
      <button class="btn download-btn" id="download-btn">Download Bracelet Image</button>
      <button class="btn order-btn" id="order-btn">Place Order</button>
    </div>

    <div class="pricing-info">
      <h3>Pricing Information</h3>
      <ul>
        <li><span class="highlight">Bracelet:</span> 10 JDs (18 slots) - 2 special charms included</li>
        <li><span class="highlight">Anklet:</span> 15 JDs (23 slots) - 2 special charms included</li>
        <li><span class="highlight">Necklace:</span> 22 JDs (34 slots) - 2 special charms included</li>
        <li>Gold: +1 JD</li>
        <li>Mix: +2.5 JDs</li>
        <li>Additional special charm: +2 JDs</li>
        <li>Rare charm: +3 JDs</li>
        <li><span class="highlight">Full Glam:</span> All special (29 JDs bracelet)</li>
      </ul>
      <p>⚠️ Limited stock! DM to order.</p>
    </div>

    <div class="charm-pools">
      <div class="charm-pool">
        <h3>Special Charms (+2 JDs each after first 2)</h3>
        <div class="charms-grid" id="special-charms">
          <!-- Special charms will be added here by JS -->
        </div>
      </div>
      
      <div class="charm-pool">
        <h3>Rare Charms (+3 JDs each)</h3>
        <div class="charms-grid" id="rare-charms">
          <!-- Rare charms will be added here by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for charm removal confirmation -->
  <div class="modal" id="remove-charm-modal">
    <div class="modal-content">
      <p>Remove this charm?</p>
      <div class="modal-buttons">
        <button class="modal-btn confirm" id="confirm-remove">Remove</button>
        <button class="modal-btn cancel" id="cancel-remove">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Order Form Modal -->
  <div class="modal" id="order-modal">
    <div class="order-modal-content">
      <h2>Place Your Order</h2>
      <form id="order-form">
        <div class="form-group">
          <label for="full-name">Full Name</label>
          <input type="text" id="full-name" required>
        </div>
        
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" required>
        </div>
        
        <div class="form-group">
          <label for="phone2">Second Phone Number (Optional)</label>
          <input type="tel" id="phone2">
        </div>
        
        <div class="form-group">
          <label for="governorate">Governorate (المحافظة)</label>
          <select id="governorate" required>
            <option value="">Select Governorate</option>
            <option value="Amman">Amman</option>
            <option value="Irbid">Irbid</option>
            <option value="Zarqa">Zarqa</option>
            <option value="Balqa">Balqa</option>
            <option value="Madaba">Madaba</option>
            <option value="Karak">Karak</option>
            <option value="Tafilah">Tafilah</option>
            <option value="Ma'an">Ma'an</option>
            <option value="Ajloun">Ajloun</option>
            <option value="Jerash">Jerash</option>
            <option value="Mafraq">Mafraq</option>
            <option value="Aqaba">Aqaba</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="address">Full Address Details</label>
          <input type="text" id="address" required>
        </div>
        
        <div class="payment-options">
          <h3>Payment Method</h3>
          <div class="payment-option">
            <input type="radio" id="pay-cliq" name="payment" value="Cliq" required>
            <label for="pay-cliq">Pay with Cliq (0788838118)</label>
          </div>
          <div class="payment-option">
            <input type="radio" id="pay-cash" name="payment" value="Cash" required>
            <label for="pay-cash">Cash on Delivery</label>
          </div>
        </div>
        
        <div id="payment-proof-container" style="display: none;">
          <label>Upload Payment Proof (if paying with Cliq)</label>
          <input type="file" id="payment-proof">
        </div>
        
        <div class="price-display">
          <div id="order-total-price">Total: 10 JDs</div>
        </div>
        
        <button type="submit" class="btn">Confirm Order</button>
        <button type="button" class="btn cancel" id="cancel-order">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Order Confirmation Modal -->
  <div class="modal" id="order-confirmation">
    <div class="order-modal-content">
      <h2>Order Confirmed!</h2>
      <p>Thank you for your order. We'll contact you soon to confirm details.</p>
      <p>Order ID: <span id="order-id"></span></p>
      <button class="btn" id="close-confirmation">Close</button>
    </div>
  </div>

  <!-- Add Firebase and html2canvas scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <script>
    // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
    const firebaseConfig = {
  apiKey: "AIzaSyD_iOEwu71dL4Lmfl7Km8lSlYFzSuubbzY",
  authDomain: "italian-charms.firebaseapp.com",
  projectId: "italian-charms",
  storageBucket: "italian-charms.firebasestorage.app",
  messagingSenderId: "156559643870",
  appId: "1:156559643870:web:a14807a2a6d1761b71de4f"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    document.addEventListener('DOMContentLoaded', () => {
      // DOM Elements
      const jewelryPiece = document.getElementById('jewelry-piece');
      const fullGlamBtn = document.getElementById('full-glam-btn');
      const productBtns = document.querySelectorAll('.product-btn');
      const materialOptions = document.querySelectorAll('.material-option');
      const basePriceDisplay = document.getElementById('base-price');
      const charmPriceDisplay = document.getElementById('charm-price');
      const totalPriceDisplay = document.getElementById('total-price');
      const specialCharmsGrid = document.getElementById('special-charms');
      const rareCharmsGrid = document.getElementById('rare-charms');
      const removeCharmModal = document.getElementById('remove-charm-modal');
      const confirmRemoveBtn = document.getElementById('confirm-remove');
      const cancelRemoveBtn = document.getElementById('cancel-remove');
      const downloadBtn = document.getElementById('download-btn');
      const orderBtn = document.getElementById('order-btn');
      const orderModal = document.getElementById('order-modal');
      const orderForm = document.getElementById('order-form');
      const cancelOrderBtn = document.getElementById('cancel-order');
      const orderConfirmation = document.getElementById('order-confirmation');
      const closeConfirmation = document.getElementById('close-confirmation');
      const payCliqOption = document.getElementById('pay-cliq');
      const paymentProofContainer = document.getElementById('payment-proof-container');

      // Product configurations
      const products = {
        bracelet: { basePrice: 10, slots: 18, includedSpecial: 2, fullGlam: 29 },
        anklet: { basePrice: 15, slots: 23, includedSpecial: 2, fullGlam: 42 },
        necklace: { basePrice: 22, slots: 34, includedSpecial: 2, fullGlam: 64 }
      };

      // Charm image lists with sold out status
      const specialCharms = [
        { src: 'charms/img_5957.png', soldOut: false },
        { src: 'charms/img_5958.png', soldOut: true },
        { src: 'charms/img_5959.png', soldOut: false },
        // ... rest of your special charms ...
      ];

      const rareCharms = [
        { src: 'rares/img_6035.png', soldOut: false },
        { src: 'rares/img_6036.png', soldOut: false },
        // ... rest of your rare charms ...
      ];

      // Current state
      let currentProduct = 'bracelet';
      let selectedCharm = null;
      let materialType = 'silver';
      let specialCount = 0;
      let rareCount = 0;
      let includedSpecialUsed = 0;
      let usedCharms = new Set();
      let slotToRemove = null;

      // Initialize
      initProduct(currentProduct);
      initCharms();

      // Product selection
      productBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          productBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentProduct = btn.dataset.type;
          initProduct(currentProduct);
          calculatePrice();
        });
      });

      // Material selection
      materialOptions.forEach(option => {
        option.addEventListener('click', () => {
          materialOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          materialType = option.dataset.material;
          updateBaseCharms();
          calculatePrice();
        });
      });

      // Update base charms based on material selection
      function updateBaseCharms() {
        const slots = document.querySelectorAll('.slot');
        slots.forEach((slot, index) => {
          // Only update if there's no decorative charm in the slot
          if (!slot.querySelector('img[data-type="special"], img[data-type="rare"]')) {
            slot.innerHTML = '';
            const img = document.createElement('img');
            if (materialType === 'silver') {
              img.src = 'basecharms/silver.png';
              img.alt = 'Silver Base';
            } else if (materialType === 'gold') {
              img.src = 'basecharms/gold.png';
              img.alt = 'Gold Base';
            } else if (materialType === 'mix') {
              const isGold = index % 2 === 0;
              img.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
              img.alt = isGold ? 'Gold Base' : 'Silver Base';
            }
            img.dataset.type = 'base';
            slot.appendChild(img);
          }
        });
      }

      // Full glam button
      fullGlamBtn.addEventListener('click', () => {
        const price = products[currentProduct].fullGlam;
        if (confirm(`Set all charms to special for ${price} JDs?`)) {
          jewelryPiece.innerHTML = '';
          usedCharms = new Set();
          createSlots(currentProduct);
          
          const slots = document.querySelectorAll('.slot');
          slots.forEach((slot, index) => {
            slot.innerHTML = '';
            const charm = specialCharms[index % specialCharms.length];
            const img = document.createElement('img');
            img.src = charm.src;
            img.alt = 'Special Charm';
            img.dataset.type = 'special';
            img.dataset.charm = charm.src.split('/').pop();
            if (charm.soldOut) {
              img.classList.add('sold-out');
            }
            slot.appendChild(img);
            
            usedCharms.add(charm.src.split('/').pop());
            updateCharmUsage();
          });
          
          specialCount = products[currentProduct].slots;
          includedSpecialUsed = products[currentProduct].includedSpecial;
          rareCount = 0;
          calculatePrice();
        }
      });

      // Initialize product slots
      function initProduct(product) {
        jewelryPiece.innerHTML = '';
        usedCharms = new Set();
        createSlots(product);
        updateCharmUsage();
        calculatePrice();
      }

      // Create slots for the product
      function createSlots(product) {
        const config = products[product];
        specialCount = 0;
        rareCount = 0;
        includedSpecialUsed = 0;
        
        for (let i = 0; i < config.slots; i++) {
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.dataset.index = i;
          
          const img = document.createElement('img');
          if (materialType === 'silver') {
            img.src = 'basecharms/silver.png';
            img.alt = 'Silver Base';
          } else if (materialType === 'gold') {
            img.src = 'basecharms/gold.png';
            img.alt = 'Gold Base';
          } else if (materialType === 'mix') {
            const isGold = i % 2 === 0;
            img.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
            img.alt = isGold ? 'Gold Base' : 'Silver Base';
          }
          img.dataset.type = 'base';
          slot.appendChild(img);
          
          slot.addEventListener('click', function() {
            handleSlotClick(this);
          });
          
          jewelryPiece.appendChild(slot);
        }
      }

      // Handle slot click events
      function handleSlotClick(slot) {
        const currentCharm = slot.querySelector('img[data-type="special"], img[data-type="rare"]');
        
        if (currentCharm && !selectedCharm) {
          slotToRemove = slot;
          removeCharmModal.style.display = 'flex';
          return;
        }
        
        if (selectedCharm) {
          addCharmToSlot(slot);
        }
      }

      // Add a charm to a slot
      function addCharmToSlot(slot) {
        if (selectedCharm.classList.contains('sold-out')) {
          alert('This charm is sold out!');
          return;
        }

        const charmSrc = selectedCharm.src.split('/').pop();
        if (usedCharms.has(charmSrc)) {
          alert('This charm is already used on the bracelet!');
          return;
        }

        // Remove any existing decorative charm first
        const existingCharm = slot.querySelector('img[data-type="special"], img[data-type="rare"]');
        if (existingCharm) {
          usedCharms.delete(existingCharm.dataset.charm);
          
          // Update counts for previous charm
          if (existingCharm.dataset.type === 'special') {
            specialCount--;
            if (includedSpecialUsed > 0) includedSpecialUsed--;
          } else if (existingCharm.dataset.type === 'rare') {
            rareCount--;
          }
        }

        // Clear the slot completely
        slot.innerHTML = '';

        // Add the new decorative charm
        const newImg = selectedCharm.cloneNode();
        newImg.classList.remove('selected');
        newImg.dataset.charm = charmSrc;
        if (selectedCharm.classList.contains('sold-out')) {
          newImg.classList.add('sold-out');
        }
        slot.appendChild(newImg);
        usedCharms.add(charmSrc);

        // Update counts for new charm
        const newType = selectedCharm.dataset.type;
        if (newType === 'special') {
          if (includedSpecialUsed < products[currentProduct].includedSpecial) {
            includedSpecialUsed++;
          } else {
            specialCount++;
          }
        } else if (newType === 'rare') {
          rareCount++;
        }

        updateCharmUsage();
        calculatePrice();
        selectedCharm = null;
        document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
      }

      // Remove charm from slot (restores base charm)
      function removeCharmFromSlot(slot) {
        const charmImg = slot.querySelector('img[data-type="special"], img[data-type="rare"]');
        if (!charmImg) return;

        const charmType = charmImg.dataset.type;
        const charmSrc = charmImg.dataset.charm;

        // Remove the decorative charm
        slot.removeChild(charmImg);
        usedCharms.delete(charmSrc);

        // Add back the base charm
        const baseImg = document.createElement('img');
        if (materialType === 'silver') {
          baseImg.src = 'basecharms/silver.png';
          baseImg.alt = 'Silver Base';
        } else if (materialType === 'gold') {
          baseImg.src = 'basecharms/gold.png';
          baseImg.alt = 'Gold Base';
        } else if (materialType === 'mix') {
          const isGold = parseInt(slot.dataset.index) % 2 === 0;
          baseImg.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
          baseImg.alt = isGold ? 'Gold Base' : 'Silver Base';
        }
        baseImg.dataset.type = 'base';
        slot.appendChild(baseImg);

        // Update counts
        if (charmType === 'special') {
          specialCount--;
          if (includedSpecialUsed > 0) includedSpecialUsed--;
        } else if (charmType === 'rare') {
          rareCount--;
        }

        updateCharmUsage();
        calculatePrice();
      }

      // Initialize charms in the pools
      function initCharms() {
        specialCharmsGrid.innerHTML = '';
        rareCharmsGrid.innerHTML = '';

        specialCharms.forEach((charm, index) => {
          const charmEl = createCharm(charm.src, `Special Charm ${index+1}`, 'special');
          charmEl.classList.add('special');
          charmEl.dataset.charm = charm.src.split('/').pop();
          
          if (charm.soldOut) {
            charmEl.classList.add('sold-out');
            const soldOutLabel = document.createElement('div');
            soldOutLabel.className = 'sold-out-label';
            soldOutLabel.textContent = 'Sold Out';
            charmEl.appendChild(soldOutLabel);
          }
          
          specialCharmsGrid.appendChild(charmEl);
        });
        
        rareCharms.forEach((charm, index) => {
          const charmEl = createCharm(charm.src, `Rare Charm ${index+1}`, 'rare');
          charmEl.classList.add('rare');
          charmEl.dataset.charm = charm.src.split('/').pop();
          
          if (charm.soldOut) {
            charmEl.classList.add('sold-out');
            const soldOutLabel = document.createElement('div');
            soldOutLabel.className = 'sold-out-label';
            soldOutLabel.textContent = 'Sold Out';
            charmEl.appendChild(soldOutLabel);
          }
          
          rareCharmsGrid.appendChild(charmEl);
        });
      }

      // Create a charm element
      function createCharm(src, alt, type) {
        const charm = document.createElement('img');
        charm.className = 'charm';
        charm.src = src;
        charm.alt = alt;
        charm.dataset.type = type;
        
        charm.addEventListener('click', function() {
          if (this.classList.contains('sold-out')) {
            alert('This charm is sold out!');
            return;
          }
          
          document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          selectedCharm = this;
        });
        
        return charm;
      }

      // Update charm usage indicators
      function updateCharmUsage() {
        // First remove all used classes from gallery charms
        document.querySelectorAll('.charms-grid .charm').forEach(charm => {
          charm.classList.remove('used');
        });

        // Add used class only to gallery charms (not bracelet charms)
        usedCharms.forEach(charmSrc => {
          const charmEl = document.querySelector(`.charms-grid .charm[src$="${charmSrc}"]`);
          if (charmEl) {
            charmEl.classList.add('used');
          }
        });
      }

      // Calculate and update price display
      function calculatePrice() {
        const config = products[currentProduct];
        let basePrice = config.basePrice;
        
        if (materialType === 'gold') basePrice += 1;
        if (materialType === 'mix') basePrice += 2.5;
        
        const specialCost = Math.max(0, specialCount) * 2;
        const rareCost = rareCount * 3;
        
        const totalCharmCost = specialCost + rareCost;
        const total = basePrice + totalCharmCost;
        
        basePriceDisplay.textContent = `Base Price: ${basePrice} JDs`;
        charmPriceDisplay.textContent = `Charms: ${totalCharmCost} JDs (${includedSpecialUsed}/${products[currentProduct].includedSpecial} free specials used)`;
        totalPriceDisplay.textContent = `Total: ${total} JDs`;
      }

      // Download Bracelet as Image
      downloadBtn.addEventListener('click', function() {
        html2canvas(document.getElementById('jewelry-piece')).then(canvas => {
          const link = document.createElement('a');
          link.download = 'my-bracelet-design.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      });

      // Order Placement
      // Show payment proof upload when Cliq is selected
      payCliqOption.addEventListener('change', function() {
        paymentProofContainer.style.display = this.checked ? 'block' : 'none';
      });

      // Open order modal
      orderBtn.addEventListener('click', function() {
        // Update order total price display
        document.getElementById('order-total-price').textContent = 
          document.getElementById('total-price').textContent;
        orderModal.style.display = 'flex';
      });

      // Close order modal
      cancelOrderBtn.addEventListener('click', function() {
        orderModal.style.display = 'none';
      });

      // Close confirmation modal
      closeConfirmation.addEventListener('click', function() {
        orderConfirmation.style.display = 'none';
      });

      // Handle form submission
      orderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form values
        const orderData = {
          name: document.getElementById('full-name').value,
          phone: document.getElementById('phone').value,
          phone2: document.getElementById('phone2').value || '',
          governorate: document.getElementById('governorate').value,
          address: document.getElementById('address').value,
          paymentMethod: document.querySelector('input[name="payment"]:checked').value,
          totalPrice: document.getElementById('total-price').textContent,
          design: [], // We'll add the bracelet design here
          status: 'pending',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Get all charms in bracelet
        const slots = document.querySelectorAll('.slot img[data-type="special"], .slot img[data-type="rare"]');
        orderData.design = Array.from(slots).map(slot => ({
          type: slot.dataset.type,
          src: slot.src.split('/').pop(),
          soldOut: slot.classList.contains('sold-out')
        }));

        // If paying with Cliq, handle the payment proof
        let paymentProofUrl = '';
        if (orderData.paymentMethod === 'Cliq') {
          const file = document.getElementById('payment-proof').files[0];
          if (file) {
            try {
              const storageRef = storage.ref('payment-proofs/' + Date.now() + '-' + file.name);
              await storageRef.put(file);
              paymentProofUrl = await storageRef.getDownloadURL();
              orderData.paymentProofUrl = paymentProofUrl;
            } catch (error) {
              console.error('Error uploading payment proof:', error);
              alert('Error uploading payment proof. Please try again.');
              return;
            }
          } else {
            alert('Please upload proof of payment for Cliq payment');
            return;
          }
        }

        // Save order to Firestore
        try {
          const docRef = await db.collection('orders').add(orderData);
          
          // Show confirmation
          document.getElementById('order-id').textContent = docRef.id;
          orderModal.style.display = 'none';
          orderConfirmation.style.display = 'flex';
          
          // Reset form
          orderForm.reset();
          paymentProofContainer.style.display = 'none';
        } catch (error) {
          console.error('Error saving order: ', error);
          alert('There was an error saving your order. Please try again.');
        }
      });

      // Modal event handlers
      confirmRemoveBtn.addEventListener('click', () => {
        if (slotToRemove) {
          removeCharmFromSlot(slotToRemove);
          slotToRemove = null;
        }
        removeCharmModal.style.display = 'none';
      });

      cancelRemoveBtn.addEventListener('click', () => {
        slotToRemove = null;
        removeCharmModal.style.display = 'none';
      });

      // Window click handlers for modals
      window.addEventListener('click', (event) => {
        if (event.target === removeCharmModal) {
          slotToRemove = null;
          removeCharmModal.style.display = 'none';
        }
        if (event.target === orderModal) {
          orderModal.style.display = 'none';
        }
        if (event.target === orderConfirmation) {
          orderConfirmation.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
