<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jewelry Designer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background: #ffe6f0;
      color: #333;
      margin: 0;
      padding: 1rem;
    }

    /* [Previous CSS remains exactly the same until .charm class] */

    .charm {
      width: 45px;
      height: 45px;
      cursor: pointer;
      transition: transform 0.2s;
      object-fit: contain;
      position: relative;
    }

    .charm-quantity {
      position: absolute;
      bottom: -5px;
      right: -5px;
      background: #d6336c;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }

    /* [Rest of the CSS remains exactly the same] */
  </style>
</head>
<body>
  <!-- [Previous HTML remains exactly the same] -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // [Previous variable declarations remain the same until charm lists]

      // Charm image lists with quantities
      const specialCharms = [
        { src: 'img_5957.png', quantity: 5 },
        { src: 'img_5958.png', quantity: 5 },
        { src: 'img_5959.png', quantity: 5 },
        // [Add quantities for all special charms]
      ];

      const rareCharms = [
        { src: 'img_6035.png', quantity: 3 },
        { src: 'img_6036.png', quantity: 3 },
        // [Add quantities for all rare charms]
      ];

      // Track used charm quantities
      const usedCharms = {
        special: {},
        rare: {}
      };

      // Initialize used charms tracking
      specialCharms.forEach(charm => {
        usedCharms.special[charm.src] = 0;
      });
      rareCharms.forEach(charm => {
        usedCharms.rare[charm.src] = 0;
      });

      // [Previous initialization code remains the same until createSlots]

      // Create slots for the product
      function createSlots(product) {
        const config = products[product];
        specialCount = 0;
        rareCount = 0;
        includedSpecialUsed = 0;
        
        for (let i = 0; i < config.slots; i++) {
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.dataset.index = i;
          
          // Add base charm to slot
          const img = document.createElement('img');
          if (materialType === 'silver') {
            img.src = 'basecharms/silver.png';
            img.alt = 'Silver Base';
          } else if (materialType === 'gold') {
            img.src = 'basecharms/gold.png';
            img.alt = 'Gold Base';
          } else if (materialType === 'mix') {
            const isGold = i % 2 === 0;
            img.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
            img.alt = isGold ? 'Gold Base' : 'Silver Base';
          }
          img.dataset.type = 'base';
          slot.appendChild(img);
          
          slot.addEventListener('click', () => {
            if (selectedCharm) {
              // Check if charm is available
              const charmType = selectedCharm.dataset.type;
              const charmSrc = selectedCharm.src.split('/').pop();
              const maxQuantity = charmType === 'special' ? 
                specialCharms.find(c => c.src === charmSrc).quantity :
                rareCharms.find(c => c.src === charmSrc).quantity;
              
              if (usedCharms[charmType][charmSrc] >= maxQuantity) {
                alert('This charm is out of stock!');
                return;
              }

              // Replace the charm in this slot
              const prevImg = slot.querySelector('img');
              const prevType = prevImg.dataset.type;
              const prevSrc = prevImg.src.split('/').pop();
              
              if (prevType === 'special') {
                specialCount--;
                if (includedSpecialUsed > 0) includedSpecialUsed--;
                usedCharms.special[prevSrc]--;
                updateCharmQuantities();
              }
              if (prevType === 'rare') {
                rareCount--;
                usedCharms.rare[prevSrc]--;
                updateCharmQuantities();
              }
              
              slot.innerHTML = '';
              const newImg = document.createElement('img');
              newImg.src = selectedCharm.src;
              newImg.alt = selectedCharm.alt;
              newImg.dataset.type = selectedCharm.dataset.type;
              slot.appendChild(newImg);
              
              if (selectedCharm.dataset.type === 'special') {
                if (includedSpecialUsed < products[currentProduct].includedSpecial) {
                  includedSpecialUsed++;
                } else {
                  specialCount++;
                }
                usedCharms.special[charmSrc]++;
                updateCharmQuantities();
              }
              if (selectedCharm.dataset.type === 'rare') {
                rareCount++;
                usedCharms.rare[charmSrc]++;
                updateCharmQuantities();
              }
              
              calculatePrice();
            }
          });
          
          jewelryPiece.appendChild(slot);
        }
      }

      // Update charm quantity indicators
      function updateCharmQuantities() {
        document.querySelectorAll('.charm').forEach(charmEl => {
          const type = charmEl.dataset.type;
          const src = charmEl.src.split('/').pop();
          const maxQuantity = type === 'special' ? 
            specialCharms.find(c => c.src === src).quantity :
            rareCharms.find(c => c.src === src).quantity;
          const used = usedCharms[type][src];
          const remaining = maxQuantity - used;
          
          // Remove existing quantity indicator if any
          const existingIndicator = charmEl.querySelector('.charm-quantity');
          if (existingIndicator) {
            charmEl.removeChild(existingIndicator);
          }
          
          // Add new quantity indicator
          const indicator = document.createElement('div');
          indicator.className = 'charm-quantity';
          indicator.textContent = remaining;
          charmEl.appendChild(indicator);
          
          // Disable if out of stock
          if (remaining <= 0) {
            charmEl.style.opacity = '0.5';
            charmEl.style.cursor = 'not-allowed';
          } else {
            charmEl.style.opacity = '1';
            charmEl.style.cursor = 'pointer';
          }
        });
      }

      // Initialize charms in the pools
      function initCharms() {
        // Special charms
        specialCharms.forEach((charm, index) => {
          const charmEl = createCharm('charms/' + charm.src, 'Special Charm ' + (index+1), 'special');
          charmEl.classList.add('special');
          
          // Add quantity indicator
          const indicator = document.createElement('div');
          indicator.className = 'charm-quantity';
          indicator.textContent = charm.quantity;
          charmEl.appendChild(indicator);
          
          specialCharmsGrid.appendChild(charmEl);
        });
        
        // Rare charms
        rareCharms.forEach((charm, index) => {
          const charmEl = createCharm('rares/' + charm.src, 'Rare Charm ' + (index+1), 'rare');
          charmEl.classList.add('rare');
          
          // Add quantity indicator
          const indicator = document.createElement('div');
          indicator.className = 'charm-quantity';
          indicator.textContent = charm.quantity;
          charmEl.appendChild(indicator);
          
          rareCharmsGrid.appendChild(charmEl);
        });
      }

      // [Rest of the JavaScript remains the same]
    });
  </script>
</body>
</html>
