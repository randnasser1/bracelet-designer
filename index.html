<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jewelry Designer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      background: #ffe6f0;
      color: #333;
      margin: 0;
      padding: 1rem;
    }

    h1, h2, h3 {
      color: #d6336c;
      margin-bottom: 1rem;
      text-align: center;
    }

    .main-content {
      max-width: 1000px;
      margin: 0 auto;
    }

    .product-selector {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .product-btn {
      background: #ff85b3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .product-btn.active {
      background: #d6336c;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #d6336c;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .control-group {
      background: rgba(255, 255, 255, 0.7);
      padding: 0.6rem;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .btn {
      background: #ff85b3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .btn:hover {
      background: #ff5fa3;
    }

    .download-btn {
      background: #4CAF50;
    }

    .order-btn {
      background: #d6336c;
    }

    .bracelet-container {
      width: 100%;
      overflow-x: auto;
      padding-bottom: 10px;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    #jewelry-piece {
      display: flex;
      gap: 8px;
      padding: 1rem;
      border: 2px dashed #f5a0c2;
      border-radius: 16px;
      background: #fff0f5;
      min-height: 80px;
      width: max-content;
      min-width: 100%;
    }

    .bracelet-container::-webkit-scrollbar {
      height: 6px;
    }

    .bracelet-container::-webkit-scrollbar-track {
      background: #fff0f5;
      border-radius: 3px;
    }

    .bracelet-container::-webkit-scrollbar-thumb {
      background: #ff85b3;
      border-radius: 3px;
    }

    .slot {
      flex: 0 0 50px;
      height: 50px;
      border: 2px dashed #f5a0c2;
      border-radius: 10px;
      background: rgba(255, 160, 195, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
    }

    .slot:empty::after {
      content: "+";
      position: absolute;
      color: #d6336c;
      font-size: 1.2rem;
      opacity: 0.5;
    }

    .slot img {
      width: 42px;
      height: 42px;
      object-fit: contain;
    }

    .price-display {
      font-size: 1.1rem;
      font-weight: 600;
      color: #d6336c;
      margin: 0.5rem 0;
      text-align: center;
    }

    .charm-pools {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .charm-pool {
      background: #fff0f5;
      border: 1px solid #f5a0c2;
      border-radius: 16px;
      padding: 0.8rem;
    }

    .charm-pool h3 {
      color: #a61e4d;
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .charms-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .charm {
      width: 45px;
      height: 45px;
      cursor: pointer;
      transition: transform 0.2s;
      object-fit: contain;
      position: relative;
    }

    .charm:hover {
      transform: scale(1.1);
    }

    .special {
      border: 2px solid #ff85b3;
      border-radius: 8px;
    }

    .rare {
      border: 2px solid purple;
      border-radius: 8px;
    }

    .charm.sold-out {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .charm.used {
      position: relative;
    }

    .charm.used::after {
      content: "✓";
      position: absolute;
      top: -8px;
      right: -8px;
      background: #d6336c;
      color: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .sold-out-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(214, 51, 108, 0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .pricing-info {
      display: none;
      background: #fff0f5;
      border: 1px solid #f5a0c2;
      border-radius: 16px;
      padding: 1rem;
      margin: 1rem auto;
      max-width: 600px;
      box-shadow: 0 2px 8px rgba(214, 51, 108, 0.1);
    }

    .pricing-info.visible {
      display: block;
    }

    .pricing-toggle {
      text-align: center;
      margin: 1rem 0;
    }

    .pricing-toggle-btn {
      background: #ff85b3;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 0.5rem 1.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .pricing-toggle-btn:hover {
      background: #d6336c;
      transform: translateY(-1px);
    }

    .highlight {
      color: #d6336c;
      font-weight: 600;
    }

    .selected {
      box-shadow: 0 0 0 3px #d6336c;
    }

    .material-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .material-option {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      font-size: 0.8rem;
    }

    .material-option.selected {
      border-color: #d6336c;
      background: rgba(214, 51, 108, 0.1);
    }

    .material-option.silver {
      background: #e0e0e0;
    }

    .material-option.gold {
      background: linear-gradient(135deg, #ffd700, #daa520);
    }

    .material-option.mix {
      background: linear-gradient(135deg, #e0e0e0 50%, #ffd700 50%);
    }

    /* Order Form Styles */
    .order-form {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem auto;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #d6336c;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #f5a0c2;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
    }
    
    .payment-options {
      margin: 1rem 0;
    }
    
    .payment-option {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      width: 100%;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .order-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      padding: 8px 16px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    
    .modal-btn.confirm {
      background-color: #d6336c;
      color: white;
    }
    
    .modal-btn.cancel {
      background-color: #e0e0e0;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    
    /* Subcategory styles */
    .category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .category-tab {
      background: #f5a0c2;
      color: white;
      border: none;
      border-radius: 16px;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-tab.active {
      background: #d6336c;
      font-weight: bold;
    }

    /* Custom charm upload */
    .custom-charm-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .custom-charm-preview {
      width: 50px;
      height: 50px;
      border: 2px dashed #d6336c;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .custom-charm-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    @media (max-width: 480px) {
      .slot {
        flex: 0 0 45px;
        height: 45px;
      }
      .slot img {
        width: 38px;
        height: 38px;
      }
      #jewelry-piece {
        padding: 0.8rem;
        gap: 6px;
      }
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>

  <div class="cart-section">
  <button class="btn" id="add-to-cart-btn">Add to Cart</button>
  <div id="cart-items" class="cart-items"></div>
</div>

<style>
.cart-section {
  margin: 1rem 0;
  text-align: center;
}
.cart-items {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
  margin-top: 1rem;
}
.cart-item {
  background: white;
  padding: 1rem;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative;
}
.cart-item img {
  width: 100px;
  height: auto;
}
.remove-item {
  position: absolute;
  top: -5px;
  right: -5px;
  background: red;
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  cursor: pointer;
}

  .cart-summary {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .cart-item-details {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .receipt {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      max-width: 500px;
      margin: 1rem auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .receipt-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px dashed #eee;
    }
    
    .receipt-total {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 1rem;
      border-top: 2px solid #d6336c;
      padding-top: 0.5rem;
    }
    
    .charm-counter {
      display: inline-block;
      background: #d6336c;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      text-align: center;
      line-height: 20px;
      font-size: 0.8rem;
      margin-left: 5px;
    }
</style>
</head>
<body>
  <div class="main-content">
    <h1>Jewelry Designer</h1>
    
    <div class="product-selector">
      <button class="product-btn active" data-type="bracelet">Bracelet</button>
      <button class="product-btn" data-type="anklet">Anklet</button>
      <button class="product-btn" data-type="necklace">Necklace</button>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <span>Material:</span>
        <div class="material-selector">
          <div class="material-option silver selected" data-material="silver">Silver</div>
          <div class="material-option gold" data-material="gold">Gold (+1 JD)</div>
          <div class="material-option mix" data-material="mix">Mix (+2.5 JDs)</div>
        </div>
      </div>
      
      <div class="control-group">
        <label for="size">Size:</label>
        <select id="size" class="btn">
          <option value="15.2-16.2">15.2cm - 16.2cm (18 charms)</option>
          <option value="16.2-17.1">16.2cm - 17.1cm (+0.5 JDs, 19 charms)</option>
          <option value="17.1-18.1">17.1cm - 18.1cm (+1 JD, 20 charms)</option>
          <option value="18.1-19.2">18.1cm - 19.2cm (+1.5 JDs, 21 charms)</option>
          <option value="19.2-20">19.2cm - 20cm (+2 JDs, 22 charms)</option>
          <option value="20-21">20cm - 21cm (+2.5 JDs, 23 charms)</option>
          <option value="21-22">21cm - 22cm (+3 JDs, 24 charms)</option>
        </select>
      </div>
      
      <div class="control-group">
        <button class="btn" id="full-glam-btn">Full Glam Look</button>
      </div>
    </div>

    <div class="bracelet-container">
      <div id="jewelry-piece"></div>
    </div>

    <div class="price-display">
      <div id="base-price">Base Price: 10 JDs</div>
      <div id="charm-price">Charms: 0 JDs (0/18 free specials used)</div>
      <div id="total-price">Total: 10 JDs</div>
    </div>

    <div class="action-buttons">
      <button class="btn download-btn" id="download-btn">Download Bracelet Image</button>
      <button class="btn order-btn" id="order-btn">Place Order</button>
    </div>

    <div class="pricing-toggle">
      <button class="pricing-toggle-btn" id="pricing-toggle">Show Pricing Info</button>
    </div>

    <div class="pricing-info">
      <h3>Pricing Information</h3>
      <ul>
        <li><span class="highlight">Bracelet:</span> 10 JDs (18 slots) - 2 special charms included</li>
<li><span class="highlight">Anklet:</span> 15 JDs (23 slots) - 2 special charms included</li>
<li><span class="highlight">Necklace:</span> 22 JDs (34 slots) - 2 special charms included</li>
        <li>Gold: +1 JD</li>
        <li>Mix: +2.5 JDs</li>
        <li>Additional special charm: +2 JDs</li>
        <li>Rare charm: +3 JDs</li>
        <li><span class="highlight">Custom charm:</span> +3.5 JDs (upload your own image)</li>
<li><span class="highlight">Full Glam:</span> Fixed 29 JDs (18 special charms included) + rare/custom charms extra</li>
        <li><span class="highlight">Size Upgrades:</span></li>
        <li>16.2-17.1cm: +0.5 JDs (19 charms)</li>
        <li>17.1-18.1cm: +1 JD (20 charms)</li>
        <li>18.1-19.2cm: +1.5 JDs (21 charms)</li>
        <li>19.2-20cm: +2 JDs (22 charms)</li>
        <li>20-21cm: +2.5 JDs (23 charms)</li>
        <li>21-22cm: +3 JDs (24 charms)</li>
      </ul>
      <p>⚠️ Limited stock! DM to order.</p>
    </div>

    <!-- Custom Charm Upload Section -->
    <div class="charm-pool">
      <h3>Custom Charms (+3.5 JDs each)</h3>
      <div class="custom-charm-upload">
        <div class="custom-charm-preview" id="custom-charm-preview">
          <span>Preview</span>
        </div>
        <input type="file" id="custom-charm-upload" accept="image/*">
        <button class="btn" id="add-custom-charm">Add Custom Charm</button>
      </div>
    </div>

    <div class="charm-pools">
      <!-- Special Charms -->
      <div class="charm-pool">
        <h3>Special Charms (+2 JDs each after first 18 in Full Glam)</h3>
        <div class="category-tabs" id="special-categories">
          <button class="category-tab active" data-category="all">All</button>
          <button class="category-tab" data-category="teddy">Teddy Bears</button>
          <button class="category-tab" data-category="bows">Bows</button>
          <button class="category-tab" data-category="beach">Beach</button>
          <button class="category-tab" data-category="red">Red</button>
          <button class="category-tab" data-category="cute">First collection</button>
          <button class="category-tab" data-category="cutespecials">Cute</button>
          <button class="category-tab" data-category="8ball">8 Ball</button>
          <button class="category-tab" data-category="mushrooms">Mushrooms</button>
          <button class="category-tab" data-category="simple">Simple & Cute</button>
        </div>
        <div class="charms-grid" id="special-charms">
          <!-- Special charms will be added here by JS -->
        </div>
      </div>

      <!-- Rare Charms -->
      <div class="charm-pool">
        <h3>Rare Charms (+3 JDs each)</h3>
        <div class="category-tabs" id="rare-categories">
          <button class="category-tab active" data-category="all">All</button>
          <button class="category-tab" data-category="sanrio">Sanrio</button>
          <button class="category-tab" data-category="hgs">Hot Girl Summer</button>
          <button class="category-tab" data-category="sporty">Sporty</button>
          <button class="category-tab" data-category="gold">Gold</button>
          <button class="category-tab" data-category="disney">Disney</button>
          <button class="category-tab" data-category="love">Love/Friends/Family</button>
          <button class="category-tab" data-category="dangly">Dangly</button>
          <button class="category-tab" data-category="graduation">Graduation</button>
          <button class="category-tab" data-category="long">Long</button>
        </div>
        <div class="charms-grid" id="rare-charms">
          <!-- Rare charms will be added here by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for charm removal confirmation -->
  <div class="modal" id="remove-charm-modal">
    <div class="modal-content">
      <p>Remove this charm?</p>
      <div class="modal-buttons">
        <button class="modal-btn confirm" id="confirm-remove">Remove</button>
        <button class="modal-btn cancel" id="cancel-remove">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Order Form Modal -->
  <div class="modal" id="order-modal">
    <div class="order-modal-content">
      <h2>Place Your Order</h2>
      <form id="order-form">
        <div class="form-group">
          <label for="full-name">Full Name</label>
          <input type="text" id="full-name" required>
        </div>
        
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" required>
        </div>
        
        <div class="form-group">
          <label for="phone2">Second Phone Number (Optional)</label>
          <input type="tel" id="phone2">
        </div>
        
        <div class="form-group">
          <label for="governorate">Governorate (المحافظة)</label>
          <select id="governorate" required>
            <option value="">Select Governorate</option>
            <option value="Amman">Amman</option>
            <option value="Irbid">Irbid</option>
            <option value="Zarqa">Zarqa</option>
            <option value="Balqa">Balqa</option>
            <option value="Madaba">Madaba</option>
            <option value="Karak">Karak</option>
            <option value="Tafilah">Tafilah</option>
            <option value="Ma'an">Ma'an</option>
            <option value="Ajloun">Ajloun</option>
            <option value="Jerash">Jerash</option>
            <option value="Mafraq">Mafraq</option>
            <option value="Aqaba">Aqaba</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="address">Full Address Details</label>
          <input type="text" id="address" required>
        </div>
        
        <div class="payment-options">
          <h3>Payment Method</h3>
          <div class="payment-option">
            <input type="radio" id="pay-cliq" name="payment" value="Cliq" required>
            <label for="pay-cliq">Pay with Cliq (0788838118)</label>
          </div>
          <div class="payment-option">
            <input type="radio" id="pay-cash" name="payment" value="Cash" required>
            <label for="pay-cash">Cash on Delivery</label>
          </div>
        </div>
        
        <div id="payment-proof-container" style="display: none;">
          <label>Upload Payment Proof (if paying with Cliq)</label>
          <input type="file" id="payment-proof">
        </div>
        
        <div class="price-display">
          <div id="order-total-price">Total: 10 JDs</div>
        </div>
        
        <button type="submit" class="btn">Confirm Order</button>
        <button type="button" class="btn cancel" id="cancel-order">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Order Confirmation Modal -->
  <div class="modal" id="order-confirmation">
    <div class="order-modal-content">
      <h2>Order Confirmed!</h2>
      <p>Thank you for your order. We'll contact you soon to confirm details.</p>
      <p>Order ID: <span id="order-id"></span></p>
      <button class="btn" id="close-confirmation">Close</button>
    </div>
  </div>

  <!-- Add Firebase and html2canvas scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

      <script>
        const firebaseConfig = {
      apiKey: "AIzaSyD_iOEwu71dL4Lmfl7Km8lSlYFzSuubbzY",
      authDomain: "italian-charms.firebaseapp.com",
      projectId: "italian-charms",
      storageBucket: "italian-charms.appspot.com",
      messagingSenderId: "156559643870",
      appId: "1:156559643870:web:a14807a2a6d1761b71de4f"
    };

    
  // Current state
  let cart = [];
  let currentDesign = {
    productType: 'bracelet',
    materialType: 'silver',
    size: '15.2-16.2',
    isFullGlam: false,
    charms: [],
    imageData: null
  };
  
// Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();


  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const jewelryPiece = document.getElementById('jewelry-piece');
    const fullGlamBtn = document.getElementById('full-glam-btn');
    const productBtns = document.querySelectorAll('.product-btn');
    const materialOptions = document.querySelectorAll('.material-option');
    const basePriceDisplay = document.getElementById('base-price');
    const charmPriceDisplay = document.getElementById('charm-price');
    const totalPriceDisplay = document.getElementById('total-price');
    const specialCharmsGrid = document.getElementById('special-charms');
    const rareCharmsGrid = document.getElementById('rare-charms');
    const removeCharmModal = document.getElementById('remove-charm-modal');
    const confirmRemoveBtn = document.getElementById('confirm-remove');
    const cancelRemoveBtn = document.getElementById('cancel-remove');
    const downloadBtn = document.getElementById('download-btn');
    const orderBtn = document.getElementById('order-btn');
    const orderModal = document.getElementById('order-modal');
    const orderForm = document.getElementById('order-form');
    const cancelOrderBtn = document.getElementById('cancel-order');
    const orderConfirmation = document.getElementById('order-confirmation');
    const closeConfirmation = document.getElementById('close-confirmation');
    const payCliqOption = document.getElementById('pay-cliq');
    const paymentProofContainer = document.getElementById('payment-proof-container');
    const customCharmUpload = document.getElementById('custom-charm-upload');
    const customCharmPreview = document.getElementById('custom-charm-preview');
    const addCustomCharmBtn = document.getElementById('add-custom-charm');
    const pricingToggle = document.getElementById('pricing-toggle');
    const pricingInfo = document.querySelector('.pricing-info');
    const sizeSelect = document.getElementById('size');
    const addToCartBtn = document.getElementById('add-to-cart-btn');

    // Product configurations
    const products = {
      bracelet: { basePrice: 10, slots: 18, includedSpecial: 2, fullGlam: 29 },
      anklet: { basePrice: 15, slots: 23, includedSpecial: 2, fullGlam: 42 },
      necklace: { basePrice: 22, slots: 34, includedSpecial: 2, fullGlam: 64 }
    };
    // Charm image lists with categories and sold out status
      const specialCharms = [
        // 8 Ball charms
        { src: 'special/8ball/38.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/39.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/40.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/41.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/42.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/43.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/44.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/45.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/46.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/48.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/49.png', category: '8ball', soldOut: false },
        { src: 'special/8ball/50.png', category: '8ball', soldOut: false },

        // Beach charms
        { src: 'special/beach/beach.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach1.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach2.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach3.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach4.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach5.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach6.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach7.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach8.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach9.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach10.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach11.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach12.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach13.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach14.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach15.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach16.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach17.png', category: 'beach', soldOut: false },
        { src: 'special/beach/beach18.png', category: 'beach', soldOut: false },

        // Bows charms
        { src: 'special/bows/beige.png', category: 'bows', soldOut: false },
        { src: 'special/bows/black.png', category: 'bows', soldOut: false },
        { src: 'special/bows/dark pink.png', category: 'bows', soldOut: false },
        { src: 'special/bows/navy.png', category: 'bows', soldOut: false },
        { src: 'special/bows/pink.png', category: 'bows', soldOut: false },
        { src: 'special/bows/purple.png', category: 'bows', soldOut: false },
        { src: 'special/bows/red.png', category: 'bows', soldOut: false },
        { src: 'special/bows/wwhite.png', category: 'bows', soldOut: false },

        // Cute and Simple charms
        { src: 'special/cute and simple/1.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/2.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/3.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/4.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/5.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/6.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/7.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/8.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/9.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/10.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/11.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/12.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/13.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/14.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/15.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/16.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/17.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/18.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/19.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/20.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/21.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/22.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/23.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/24.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/25.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/26.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/27.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/28.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/29.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/30.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/31.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/32.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/33.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/34.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/35.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/36.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/37.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c1.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c2.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c3.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c4.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c5.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c6.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c7.png', category: 'simple', soldOut: false },
        { src: 'special/cute and simple/c8.png', category: 'simple', soldOut: false },

        // Cute Specials charms
        { src: 'special/cute specials/so cute.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special girly.png', category: 'cute', soldOut: false },
        { src: 'special/cute specials/special.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special2.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special3.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special4.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special5.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special6.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special7.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special8.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special9.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special10.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special11.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special12.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special13.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special14.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special15.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special16.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special17.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special18.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special19.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special20.png', category: 'cutespecials', soldOut: false },
        { src: 'special/cute specials/special21.png', category: 'cutespecials', soldOut: false },

        // Cute charms
        { src: 'special/cute/cute.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute2.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute3.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute4.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute5.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute6.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute7.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute8.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute9.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute10.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute11.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute12.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute13.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute14.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute15.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute16.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute17.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute18.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute19.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute20.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute21.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute22.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute23.png', category: 'cute', soldOut: false },
        { src: 'special/cute/cute24.png', category: 'cute', soldOut: false },

        // Mushrooms charms
        { src: 'special/mushrooms/mushroom.png', category: 'mushrooms', soldOut: false },
        { src: 'special/mushrooms/mushroom1.png', category: 'mushrooms', soldOut: false },
        { src: 'special/mushrooms/mushroom2.png', category: 'mushrooms', soldOut: false },
        { src: 'special/mushrooms/mushroom3.png', category: 'mushrooms', soldOut: false },
        { src: 'special/mushrooms/mushroom4.png', category: 'mushrooms', soldOut: false },

        // Red charms
        { src: 'special/red/red.png', category: 'red', soldOut: false },
        { src: 'special/red/red1.png', category: 'red', soldOut: false },
        { src: 'special/red/red2.png', category: 'red', soldOut: false },
        { src: 'special/red/red3.png', category: 'red', soldOut: false },
        { src: 'special/red/red4.png', category: 'red', soldOut: false },
        { src: 'special/red/red5.png', category: 'red', soldOut: false },
        { src: 'special/red/red6.png', category: 'red', soldOut: false },
        { src: 'special/red/red7.png', category: 'red', soldOut: false },
        { src: 'special/red/red8.png', category: 'red', soldOut: false },
        { src: 'special/red/red9.png', category: 'red', soldOut: false },
        { src: 'special/red/red10.png', category: 'red', soldOut: false },
        { src: 'special/red/red11.png', category: 'red', soldOut: false },
        { src: 'special/red/red12.png', category: 'red', soldOut: false },

        // Teddy charms
        { src: 'special/teddy/teddy.png', category: 'teddy', soldOut: false },
        { src: 'special/teddy/teddy2.png', category: 'teddy', soldOut: false },
        { src: 'special/teddy/teddy3.png', category: 'teddy', soldOut: false },
        { src: 'special/teddy/teddy4.png', category: 'teddy', soldOut: false },
        { src: 'special/teddy/teddy5.png', category: 'teddy', soldOut: false },
        { src: 'special/teddy/teddy6.png', category: 'teddy', soldOut: false }
      ];

      // Rare charms
      const rareCharms = [
        // Dangly charms
        { src: 'rares/dangly/dangly.png', category: 'dangly', soldOut: false },

        // Disney charms
        { src: 'rares/disney/bluemonster.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/bunny.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/disneycat pink.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/disneycat.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/fox.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/greenmonster.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/pinkstitch.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/snjab.png', category: 'disney', soldOut: false },
        { src: 'rares/disney/stitch.png', category: 'disney', soldOut: false },

        // Gold charms
        { src: 'rares/gold/gold.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold2.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold3.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold4.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold5.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold6.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold7.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold8.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold9.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold10.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold11.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold12.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold13.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold14.png', category: 'gold', soldOut: false },
        { src: 'rares/gold/gold15.png', category: 'gold', soldOut: false },

        // Graduation charms
        { src: 'rares/graduation/grad.png', category: 'graduation', soldOut: false },
        { src: 'rares/graduation/grad.webp', category: 'graduation', soldOut: false },

        // HGS charms
        { src: 'rares/hgs/hgs.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs2.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs3.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs4.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs5.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs6.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs7.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/129.png', category: 'hgs', soldOut: false },
         { src: 'rares/hgs/130.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs9.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs10.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs11.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs12.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs13.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs14.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs15.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs16.png', category: 'hgs', soldOut: false },
        { src: 'rares/hgs/hgs17.png', category: 'hgs', soldOut: false },

        // Long charms
        { src: 'rares/long/long.png', category: 'long', soldOut: false },
        { src: 'rares/long/long2.png', category: 'long', soldOut: false },

        // Love charms
        { src: 'rares/love/best.png', category: 'love', soldOut: false },
        { src: 'rares/love/ends.png', category: 'love', soldOut: false },
        { src: 'rares/love/fri.png', category: 'love', soldOut: false },
        { src: 'rares/love/heart2.png', category: 'love', soldOut: false },
        { src: 'rares/love/love.png', category: 'love', soldOut: false },
        { src: 'rares/love/love2.png', category: 'love', soldOut: false },
        { src: 'rares/love/love3.png', category: 'love', soldOut: false },
        { src: 'rares/love/love4.png', category: 'love', soldOut: false },
        { src: 'rares/love/love5.png', category: 'love', soldOut: false },
        { src: 'rares/love/love6.png', category: 'love', soldOut: false },
        { src: 'rares/love/love7.png', category: 'love', soldOut: false },
        { src: 'rares/love/love8.png', category: 'love', soldOut: false },
        { src: 'rares/love/love9.png', category: 'love', soldOut: false },
        { src: 'rares/love/love10.png', category: 'love', soldOut: false },
        { src: 'rares/love/love11.png', category: 'love', soldOut: false },
        { src: 'rares/love/mrmrs1.png', category: 'love', soldOut: false },
        { src: 'rares/love/mrmrs2.png', category: 'love', soldOut: false },

        // Sanrio charms
        { src: 'rares/sanrio/51.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/52.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/53.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/54.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/55.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/56.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/57.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/58.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/59.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/60.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/61.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/62.png', category: 'sanrio', soldOut: false },
        { src: 'rares/sanrio/metalkitty.png', category: 'sanrio', soldOut: false },

        // Sporty charms
        { src: 'rares/sporty/sporty.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty2.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty3.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty4.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty5.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty6.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty7.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty8.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty9.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty10.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty11.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty12.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty13.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty14.png', category: 'sporty', soldOut: false },
        { src: 'rares/sporty/sporty15.png', category: 'sporty', soldOut: false }
      ];

    // Current state
    let currentProduct = 'bracelet';
    let selectedCharm = null;
    let materialType = 'silver';
    let specialCount = 0;
    let rareCount = 0;
    let customCount = 0;
    let includedSpecialUsed = 0;
    let usedCharms = new Set();
    let slotToRemove = null;
    let currentSpecialCategory = 'all';
    let currentRareCategory = 'all';
    let customCharmImage = null;
    let sizePriceAdjustment = 0;
    let isFullGlam = false;
    let fullGlamSpecialCount = 0;

    // Initialize
    initProduct(currentProduct);
    initCharms();
    setupEventListeners();
    pricingInfo.classList.remove('visible');
    pricingToggle.textContent = 'Show Pricing Info';

    function setupEventListeners() {
      // Add to cart button
      addToCartBtn.addEventListener('click', addToCart);
      document.querySelectorAll('.slot').forEach(slot => {
    slot.addEventListener('click', function() {
      handleSlotClick(this);
    });
  });
      // Product selection
      productBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          productBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentProduct = btn.dataset.type;
          currentDesign.productType = currentProduct;
          initProduct(currentProduct);
        });
      });

      // Material selection
      materialOptions.forEach(option => {
        option.addEventListener('click', () => {
          materialOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          materialType = option.dataset.material;
          currentDesign.materialType = materialType;
          updateBaseCharms();
          calculatePrice();
        });
      });

      // Full glam button
      fullGlamBtn.addEventListener('click', () => {
        if (isFullGlam) {
          // Exiting Full Glam - recalculate counts
          isFullGlam = false;
          includedSpecialUsed = Math.min(fullGlamSpecialCount, products[currentProduct].includedSpecial);
          specialCount = Math.max(0, fullGlamSpecialCount - includedSpecialUsed);
          fullGlamBtn.textContent = 'Full Glam Look';
        } else {
          // Entering Full Glam
          isFullGlam = true;
          fullGlamSpecialCount = Array.from(document.querySelectorAll('.slot img[data-type="special"]')).length;
          fullGlamBtn.textContent = 'Exit Full Glam';
        }
        calculatePrice();
      });
    // In setupEventListeners():
removeCharmModal.addEventListener('click', function(e) {
  if (e.target === this) {
    this.style.display = 'none';
    slotToRemove = null;
  }
});

document.querySelectorAll('.modal-btn.cancel').forEach(btn => {
  btn.addEventListener('click', function() {
    this.closest('.modal').style.display = 'none';
    slotToRemove = null;
  }
});
      // Size selection
      sizeSelect.addEventListener('change', function() {
        const sizeValue = this.value;
        const baseSlots = products[currentProduct].slots;
        
        jewelryPiece.innerHTML = '';
        isFullGlam = false;
        fullGlamBtn.textContent = 'Full Glam Look';
        createSlots(baseSlots);
        
        switch(sizeValue) {
          case '15.2-16.2':
            sizePriceAdjustment = 0;
            break;
          case '16.2-17.1':
            sizePriceAdjustment = 0.5;
            addExtraSlots(1);
            break;
          case '17.1-18.1':
            sizePriceAdjustment = 1;
            addExtraSlots(2);
            break;
          case '18.1-19.2':
            sizePriceAdjustment = 1.5;
            addExtraSlots(3);
            break;
          case '19.2-20':
            sizePriceAdjustment = 2;
            addExtraSlots(4);
            break;
          case '20-21':
            sizePriceAdjustment = 2.5;
            addExtraSlots(5);
            break;
          case '21-22':
            sizePriceAdjustment = 3;
            addExtraSlots(6);
            break;
        }
        
        calculatePrice();
      });

      // Pricing info toggle
      pricingToggle.addEventListener('click', () => {
        pricingInfo.classList.toggle('visible');
        pricingToggle.textContent = pricingInfo.classList.contains('visible') 
          ? 'Hide Pricing Info' 
          : 'Show Pricing Info';
      });

      // Category tabs - SPECIAL (using event delegation)
      document.getElementById('special-categories').addEventListener('click', function(e) {
        const tab = e.target.closest('.category-tab');
        if (!tab) return;
        
        document.querySelectorAll('#special-categories .category-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentSpecialCategory = tab.dataset.category;
        updateSpecialCharmsDisplay();
      });

      // Category tabs - RARE (using event delegation)
      document.getElementById('rare-categories').addEventListener('click', function(e) {
        const tab = e.target.closest('.category-tab');
        if (!tab) return;
        
        document.querySelectorAll('#rare-categories .category-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentRareCategory = tab.dataset.category;
        updateRareCharmsDisplay();
      });

      // Charm selection (using event delegation)
      document.querySelectorAll('.charms-grid').forEach(grid => {
        grid.addEventListener('click', function(e) {
          const charm = e.target.closest('.charm');
          if (!charm) return;
          
          if (charm.classList.contains('sold-out')) {
            alert('This charm is sold out!');
            return;
          }
          
          document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
          charm.classList.add('selected');
          selectedCharm = charm;
        });
      });

      // Download button
      downloadBtn.addEventListener('click', function() {
        html2canvas(document.getElementById('jewelry-piece')).then(canvas => {
          const link = document.createElement('a');
          link.download = 'my-bracelet-design.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      });

      // Custom charm upload
      customCharmUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            customCharmPreview.innerHTML = '';
            const img = document.createElement('img');
            img.src = event.target.result;
            customCharmPreview.appendChild(img);
            customCharmImage = img;
          };
          reader.readAsDataURL(file);
        }
      });

      // Add custom charm
      addCustomCharmBtn.addEventListener('click', function() {
        if (!customCharmImage) {
          alert('Please upload an image first');
          return;
        }

        const tempCharm = document.createElement('img');
        tempCharm.src = customCharmImage.src;
        tempCharm.alt = 'Custom Charm';
        tempCharm.dataset.type = 'custom';
        tempCharm.dataset.charm = 'custom-' + Date.now();
        tempCharm.classList.add('charm');
        
        document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
        tempCharm.classList.add('selected');
        selectedCharm = tempCharm;
        
        customCharmUpload.value = '';
        customCharmPreview.innerHTML = '<span>Preview</span>';
        customCharmImage = null;
      });

      // Payment proof toggle
      payCliqOption.addEventListener('change', function() {
        paymentProofContainer.style.display = this.checked ? 'block' : 'none';
      });

      // Order button
      orderBtn.addEventListener('click', function() {
        document.getElementById('order-total-price').textContent = 
          document.getElementById('total-price').textContent;
        orderModal.style.display = 'flex';
      });

      // Cancel order
      cancelOrderBtn.addEventListener('click', function() {
        orderModal.style.display = 'none';
      });

      // Close confirmation
      closeConfirmation.addEventListener('click', function() {
        orderConfirmation.style.display = 'none';
      });

      // Form submission
      orderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = orderForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;
        submitBtn.textContent = 'Processing...';
        submitBtn.disabled = true;

        try {
          const orderData = {
            name: document.getElementById('full-name').value,
            phone: document.getElementById('phone').value,
            phone2: document.getElementById('phone2').value || '',
            governorate: document.getElementById('governorate').value,
            address: document.getElementById('address').value,
            paymentMethod: document.querySelector('input[name="payment"]:checked').value,
            totalPrice: document.getElementById('total-price').textContent.replace('Total: ', ''),
            productType: currentProduct,
            materialType: materialType,
            size: sizeSelect.value,
            isFullGlam: isFullGlam,
            design: [],
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          const slots = document.querySelectorAll('.slot img[data-type="special"], .slot img[data-type="rare"], .slot img[data-type="custom"]');
          orderData.design = Array.from(slots).map(slot => ({
            type: slot.dataset.type,
            src: slot.src.split('/').pop(),
            charmName: slot.dataset.charm || 'custom'
          }));

          if (orderData.paymentMethod === 'Cliq') {
            const file = document.getElementById('payment-proof').files[0];
            if (file) {
              const storageRef = storage.ref('payment-proofs/' + Date.now() + '-' + file.name);
              await storageRef.put(file);
              orderData.paymentProofUrl = await storageRef.getDownloadURL();
            } else {
              alert('Please upload proof of payment for Cliq payment');
              submitBtn.textContent = originalBtnText;
              submitBtn.disabled = false;
              return;
            }
          }

          const docRef = await db.collection('orders').add(orderData);
          document.getElementById('order-id').textContent = docRef.id;
          orderModal.style.display = 'none';
          orderConfirmation.style.display = 'flex';
          orderForm.reset();
          paymentProofContainer.style.display = 'none';
        } catch (error) {
          console.error('Error saving order: ', error);
          alert('Error saving order: ' + error.message);
        } finally {
          submitBtn.textContent = originalBtnText;
          submitBtn.disabled = false;
        }
      });
      const orderTotal = cart.reduce((total, item) => total + item.price, 0);
        
        orderConfirmation.innerHTML = `
          <h2>Order Confirmed!</h2>
          <p>Thank you for your order. We'll contact you soon to confirm details.</p>
          <p>Order ID: <strong>${docRef.id}</strong></p>
          
          <div class="receipt">
            <h3>Receipt</h3>
            ${cart.map(item => `
              <div class="receipt-item">
                <div>
                  <strong>${item.productType.toUpperCase()}</strong><br>
                  <small>${item.materialType} | ${item.size}</small>
                </div>
                <div>${item.price} JDs</div>
              </div>
            `).join('')}
            <div class="receipt-total">
              <span>Total:</span>
              <span>${orderTotal} JDs</span>
            </div>
          </div>
          
          <button class="btn" id="close-confirmation">Close</button>
        `;
      // Modal handlers
     confirmRemoveBtn.addEventListener('click', () => {
  if (slotToRemove) {
    removeCharmFromSlot(slotToRemove);
    removeCharmModal.style.display = 'none';
    slotToRemove = null;
  }
});
    
    cancelRemoveBtn.addEventListener('click', () => {
      removeCharmModal.style.display = 'none';
      slotToRemove = null;
    });
      // Window click handlers for modals
      window.addEventListener('click', (event) => {
        if (event.target === removeCharmModal) {
          removeCharmModal.style.display = 'none';
          slotToRemove = null;
        }
        if (event.target === orderModal) {
          orderModal.style.display = 'none';
        }
        if (event.target === orderConfirmation) {
          orderConfirmation.style.display = 'none';
        }
      });
    }

    function addExtraSlots(extraCount) {
      for (let i = 0; i < extraCount; i++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.dataset.index = jewelryPiece.children.length;
        
        const img = document.createElement('img');
        if (materialType === 'silver') {
          img.src = 'basecharms/silver.png';
        } else if (materialType === 'gold') {
          img.src = 'basecharms/gold.png';
        } else if (materialType === 'mix') {
          const isGold = jewelryPiece.children.length % 2 === 0;
          img.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
        }
        img.dataset.type = 'base';
        slot.appendChild(img);
        
        slot.addEventListener('click', function() {
          handleSlotClick(this);
        });
        
        jewelryPiece.appendChild(slot);
      }
    }
function initProduct(product) {
  jewelryPiece.innerHTML = '';
  usedCharms = new Set();
  specialCount = 0;
  rareCount = 0;
  customCount = 0;
  includedSpecialUsed = 0;
  isFullGlam = false;
  fullGlamSpecialCount = 0;
  fullGlamBtn.textContent = 'Full Glam Look';
  sizePriceAdjustment = 0;
  sizeSelect.value = '15.2-16.2';
  
  createSlots(products[product].slots);
  setupSlotEventListeners(); // Make sure this is called
  updateCharmUsage();
  calculatePrice();
}
    function createSlots(slotCount) {
      for (let i = 0; i < slotCount; i++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.dataset.index = i;
        
        const img = document.createElement('img');
        if (materialType === 'silver') {
          img.src = 'basecharms/silver.png';
          img.alt = 'Silver Base';
        } else if (materialType === 'gold') {
          img.src = 'basecharms/gold.png';
          img.alt = 'Gold Base';
        } else if (materialType === 'mix') {
          const isGold = i % 2 === 0;
          img.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
          img.alt = isGold ? 'Gold Base' : 'Silver Base';
        }
        img.dataset.type = 'base';
        slot.appendChild(img);
        
        slot.addEventListener('click', function() {
          handleSlotClick(this);
        });
        
        jewelryPiece.appendChild(slot);
      }
    }
  
  function handleSlotClick(slot) {
  // If we have a selected charm, we're in "add charm" mode
  if (selectedCharm) {
    addCharmToSlot(slot);
    return;
  }

  // Check if we clicked on a decorative charm (not a base charm)
  const clickedCharm = slot.querySelector('img[data-type="special"], img[data-type="rare"], img[data-type="custom"]');
  
  // Only show remove modal if we clicked on a decorative charm
  if (clickedCharm) {
    slotToRemove = slot;
    removeCharmModal.style.display = 'flex';
  }
}
   function addCharmToSlot(slot) {
        if (!selectedCharm) return;
        
        if (selectedCharm.classList.contains('sold-out')) {
          alert('This charm is sold out!');
          return;
        }

        const charmSrc = selectedCharm.src.split('/').pop();
        if (usedCharms.has(charmSrc)) {
          alert('This charm is already used on the bracelet!');
          return;
        }

      // Remove any existing charm first
      const existingCharm = slot.querySelector('img[data-type="special"], img[data-type="rare"], img[data-type="custom"]');
        if (existingCharm) {
          removeCharmFromSlot(slot);
        }
      // Clear the slot
      slot.innerHTML = '';
        const newImg = selectedCharm.cloneNode();
        newImg.classList.remove('selected');
        newImg.dataset.charm = charmSrc;
        newImg.dataset.type = selectedCharm.dataset.type; // Make sure we copy the type
        slot.appendChild(newImg);
        usedCharms.add(charmSrc);

        // Update counts
        const newType = selectedCharm.dataset.type;
        if (newType === 'special') {
          if (isFullGlam) {
            fullGlamSpecialCount++;
          } else {
            if (includedSpecialUsed < products[currentProduct].includedSpecial) {
              includedSpecialUsed++;
            } else {
              specialCount++;
            }
          }
        } else if (newType === 'rare') {
          rareCount++;
        } else if (newType === 'custom') {
          customCount++;
        }

        updateCharmUsage();
        calculatePrice();
        selectedCharm = null;
        document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
      }
function removeCharmFromSlot(slot) {
  const charmImg = slot.querySelector('img[data-type="special"], img[data-type="rare"], img[data-type="custom"]');
  if (!charmImg) return;

  const charmType = charmImg.dataset.type;
  const charmSrc = charmImg.src.split('/').pop();

  // Clear the slot
  slot.innerHTML = '';

  // Add base charm back
  const baseImg = document.createElement('img');
  if (materialType === 'silver') {
    baseImg.src = 'basecharms/silver.png';
  } else if (materialType === 'gold') {
    baseImg.src = 'basecharms/gold.png';
  } else {
    const isGold = parseInt(slot.dataset.index) % 2 === 0;
    baseImg.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
  }
  baseImg.dataset.type = 'base';
  slot.appendChild(baseImg);

  // Update counts
  if (charmType === 'special') {
    if (isFullGlam) {
      fullGlamSpecialCount--;
    } else if (includedSpecialUsed > 0) {
      includedSpecialUsed--;
    } else {
      specialCount--;
    }
  } else if (charmType === 'rare') {
    rareCount--;
  } else if (charmType === 'custom') {
    customCount--;
  }

  // Remove from used charms
  usedCharms.delete(charmSrc);

  updateCharmUsage();
  calculatePrice();
}

    function initCharms() {
      updateSpecialCharmsDisplay();
      updateRareCharmsDisplay();
    }

    function updateSpecialCharmsDisplay() {
      specialCharmsGrid.innerHTML = '';
      
      const filteredCharms = currentSpecialCategory === 'all' 
        ? specialCharms 
        : specialCharms.filter(charm => charm.category === currentSpecialCategory);
      
      filteredCharms.forEach((charm, index) => {
        const charmEl = createCharmElement(charm.src, `Special Charm ${index+1}`, 'special');
        charmEl.classList.add('special');
        charmEl.dataset.charm = charm.src.split('/').pop();
        charmEl.dataset.category = charm.category;
        
        if (charm.soldOut) {
          charmEl.classList.add('sold-out');
          const soldOutLabel = document.createElement('div');
          soldOutLabel.className = 'sold-out-label';
          soldOutLabel.textContent = 'Sold Out';
          charmEl.appendChild(soldOutLabel);
        }
        
        specialCharmsGrid.appendChild(charmEl);
      });
    }

    function updateRareCharmsDisplay() {
      rareCharmsGrid.innerHTML = '';
      
      const filteredCharms = currentRareCategory === 'all' 
        ? rareCharms 
        : rareCharms.filter(charm => charm.category === currentRareCategory);
      
      filteredCharms.forEach((charm, index) => {
        const charmEl = createCharmElement(charm.src, `Rare Charm ${index+1}`, 'rare');
        charmEl.classList.add('rare');
        charmEl.dataset.charm = charm.src.split('/').pop();
        charmEl.dataset.category = charm.category;
        
        if (charm.soldOut) {
          charmEl.classList.add('sold-out');
          const soldOutLabel = document.createElement('div');
          soldOutLabel.className = 'sold-out-label';
          soldOutLabel.textContent = 'Sold Out';
          charmEl.appendChild(soldOutLabel);
        }
        
        rareCharmsGrid.appendChild(charmEl);
      });
    }

    function createCharmElement(src, alt, type) {
      const charm = document.createElement('img');
      charm.className = 'charm';
      charm.src = src;
      charm.alt = alt;
      charm.dataset.type = type;
      return charm;
    }

    function updateCharmUsage() {
      document.querySelectorAll('.charms-grid .charm').forEach(charm => {
        charm.classList.remove('used');
      });

      usedCharms.forEach(charmSrc => {
        const charmEl = document.querySelector(`.charms-grid .charm[src$="${charmSrc}"]`);
        if (charmEl) {
          charmEl.classList.add('used');
        }
      });
    }

     function calculatePrice() {
        let price = 0;
        let charmCost = 0;
        
        if (isFullGlam) {
          price = 29; // Full Glam base price
          // Only count rare and custom charms beyond the included 18 specials
          charmCost = (rareCount * 3) + (customCount * 3.5);
        } else {
          price = products[currentProduct].basePrice;
          if (materialType === 'gold') price += 1;
          if (materialType === 'mix') price += 2.5;
          
          // Calculate charm costs
          const specialCharged = Math.max(0, specialCount - products[currentProduct].includedSpecial);
          charmCost = (specialCharged * 2) + (rareCount * 3) + (customCount * 3.5);
        }
        
        price += sizePriceAdjustment;
        const total = price + charmCost;
        
        // Update displays
        basePriceDisplay.textContent = `Base Price: ${price} JDs`;
        charmPriceDisplay.textContent = `Charms: ${charmCost} JDs`;
        
        if (isFullGlam) {
          charmPriceDisplay.textContent += ` (${fullGlamSpecialCount}/18 free specials used)`;
        } else {
          charmPriceDisplay.textContent += ` (${includedSpecialUsed}/${products[currentProduct].includedSpecial} free specials used)`;
        }
        
        totalPriceDisplay.textContent = `Current Item: ${total} JDs`;
        
        // Update current design price
        currentDesign.price = total;
        updateCartDisplay();
      }
    function saveCurrentDesign() {
  return html2canvas(document.getElementById('jewelry-piece')).then(canvas => {
    const design = {
      productType: currentProduct,
      materialType: materialType,
      size: sizeSelect.value,
      isFullGlam: isFullGlam,
      price: calculateTotalPrice(), // You might want to add this helper function
      imageData: canvas.toDataURL('image/png'),
      charms: Array.from(document.querySelectorAll('#jewelry-piece .slot img[data-type="special"], #jewelry-piece .slot img[data-type="rare"], #jewelry-piece .slot img[data-type="custom"]'))
        .map(img => ({
          type: img.dataset.type,
          src: img.src.split('/').pop()
        }))
    };
    return design;
  });
}

    function calculateTotalPrice() {
  // Implement your price calculation logic here
  // This should return the total price as a number
  let price = products[currentProduct].basePrice;
  
  if (materialType === 'gold') price += 1;
  if (materialType === 'mix') price += 2.5;
  
  if (isFullGlam) {
    price = products[currentProduct].fullGlam;
    // Add cost for rare and custom charms
    price += (rareCount * 3) + (customCount * 3.5);
  } else {
    const specialCharged = Math.max(0, specialCount - products[currentProduct].includedSpecial);
    price += (specialCharged * 2) + (rareCount * 3) + (customCount * 3.5);
  }
  
  price += sizePriceAdjustment;
  return price;
}
function addToCart() {
  // First check if there are any charms added
  const hasCharms = document.querySelectorAll('#jewelry-piece img[data-type="special"], #jewelry-piece img[data-type="rare"], #jewelry-piece img[data-type="custom"]').length > 0;
  
  if (!hasCharms) {
    alert('Please add at least one charm before adding to cart!');
    return;
  }

  try {
    html2canvas(document.getElementById('jewelry-piece')).then(canvas => {
      const design = {
        productType: currentProduct,
        materialType: materialType,
        size: sizeSelect.value,
        isFullGlam: isFullGlam,
        price: calculateTotalPrice(),
        imageData: canvas.toDataURL('image/png'),
        charms: Array.from(document.querySelectorAll('#jewelry-piece .slot img[data-type="special"], #jewelry-piece .slot img[data-type="rare"], #jewelry-piece .slot img[data-type="custom"]'))
          .map(img => ({
            type: img.dataset.type,
            src: img.src.split('/').pop()
          })),
        id: Date.now(),
        timestamp: new Date().toLocaleString()
      };
      
      cart.push(design);
      updateCartDisplay();
      initProduct(currentProduct);
      alert('Added to cart successfully!');
    }).catch(err => {
      console.error('Canvas error:', err);
      alert('Error capturing design image. Please try again.');
    });
  } catch (err) {
    console.error('Add to cart error:', err);
    alert('Error adding to cart. Please try again.');
  }
}

    function updateCartDisplay() {
        const cartItemsEl = document.getElementById('cart-items');
        cartItemsEl.innerHTML = '';
        
        if (cart.length === 0) {
          cartItemsEl.innerHTML = '<p>Your cart is empty</p>';
          return;
        }
        
        let cartTotal = 0;
        
        // Create cart summary
        const summary = document.createElement('div');
        summary.className = 'cart-summary';
        
        cart.forEach((item, index) => {
          // Add item to display
          const itemEl = document.createElement('div');
          itemEl.className = 'cart-item';
          itemEl.innerHTML = `
            <img src="${item.imageData}" alt="${item.productType}" style="width:80px;height:auto;">
            <div>
              <strong>${item.productType.charAt(0).toUpperCase() + item.productType.slice(1)}</strong><br>
              ${item.materialType} | ${item.size}<br>
              Price: ${item.price} JDs
            </div>
            <button class="remove-item" data-index="${index}">×</button>
          `;
          cartItemsEl.appendChild(itemEl);
          
          // Add to summary
          cartTotal += item.price;
        });
        
        // Add total to summary
        summary.innerHTML = `
          <h3>Cart Summary</h3>
          ${cart.map((item, index) => `
            <div class="cart-item-details">
              <span>${index+1}. ${item.productType}</span>
              <span>${item.price} JDs</span>
            </div>
          `).join('')}
          <div class="cart-item-details" style="font-weight:bold;margin-top:10px;">
            <span>Total:</span>
            <span>${cartTotal} JDs</span>
          </div>
        `;
        
        cartItemsEl.prepend(summary);
        
        // Add remove item functionality
        document.querySelectorAll('.remove-item').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = e.target.dataset.index;
            cart.splice(index, 1);
            updateCartDisplay();
          });
        });
      }

    function updateBaseCharms() {
      const slots = document.querySelectorAll('.slot');
      slots.forEach((slot, index) => {
        const baseImg = slot.querySelector('img[data-type="base"]');
        if (baseImg) {
          if (materialType === 'silver') {
            baseImg.src = 'basecharms/silver.png';
          } else if (materialType === 'gold') {
            baseImg.src = 'basecharms/gold.png';
          } else if (materialType === 'mix') {
            const isGold = index % 2 === 0;
            baseImg.src = isGold ? 'basecharms/gold.png' : 'basecharms/silver.png';
          }
        }
      });
    }

function setupSlotEventListeners() {
  document.querySelectorAll('.slot').forEach(slot => {
    // Remove any existing listeners first
    const newSlot = slot.cloneNode(true);
    slot.parentNode.replaceChild(newSlot, slot);
    
    // Add new click listener
    newSlot.addEventListener('click', function() {
      handleSlotClick(this);
    });
  });
}
  }); // This closes the DOMContentLoaded event listener
</script>
</body>
</html>
