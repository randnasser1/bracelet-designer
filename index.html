<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Previous head content remains exactly the same] -->
</head>
<body>
  <!-- [Previous body content remains exactly the same until the script] -->

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // [Previous variable declarations and initializations remain the same]

      // Modified addCharmToSlot function to fix joining issue
      function addCharmToSlot(slot) {
        if (selectedCharm.classList.contains('sold-out')) {
          alert('This charm is sold out!');
          return;
        }

        const charmSrc = selectedCharm.src.split('/').pop();
        if (usedCharms.has(charmSrc)) {
          alert('This charm is already used on the bracelet!');
          return;
        }

        // Clear only the decorative charm, keep the base charm
        const existingCharm = slot.querySelector('img[data-type="special"], img[data-type="rare"]');
        if (existingCharm) {
          slot.removeChild(existingCharm);
          usedCharms.delete(existingCharm.dataset.charm);
          
          // Update counts for previous charm
          if (existingCharm.dataset.type === 'special') {
            specialCount--;
            if (includedSpecialUsed > 0) includedSpecialUsed--;
          } else if (existingCharm.dataset.type === 'rare') {
            rareCount--;
          }
        }

        // Add the new decorative charm
        const newImg = selectedCharm.cloneNode();
        newImg.classList.remove('selected');
        newImg.dataset.charm = charmSrc;
        slot.appendChild(newImg);
        usedCharms.add(charmSrc);

        // Update counts for new charm
        const newType = selectedCharm.dataset.type;
        if (newType === 'special') {
          if (includedSpecialUsed < products[currentProduct].includedSpecial) {
            includedSpecialUsed++;
          } else {
            specialCount++;
          }
        } else if (newType === 'rare') {
          rareCount++;
        }

        updateCharmUsage();
        calculatePrice();
        selectedCharm = null;
        document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
      }

      // Modified initCharms function to fix sold-out display
      function initCharms() {
        specialCharmsGrid.innerHTML = '';
        rareCharmsGrid.innerHTML = '';

        specialCharms.forEach((charm, index) => {
          const charmEl = createCharm(charm.src, `Special Charm ${index+1}`, 'special');
          charmEl.classList.add('special');
          charmEl.dataset.charm = charm.src.split('/').pop();
          
          if (charm.soldOut) {
            charmEl.classList.add('sold-out');
            charmEl.style.opacity = '1'; // Keep full opacity in gallery
            const soldOutLabel = document.createElement('div');
            soldOutLabel.className = 'sold-out-label';
            soldOutLabel.textContent = 'Sold Out';
            charmEl.appendChild(soldOutLabel);
          }
          
          specialCharmsGrid.appendChild(charmEl);
        });
        
        rareCharms.forEach((charm, index) => {
          const charmEl = createCharm(charm.src, `Rare Charm ${index+1}`, 'rare');
          charmEl.classList.add('rare');
          charmEl.dataset.charm = charm.src.split('/').pop();
          
          if (charm.soldOut) {
            charmEl.classList.add('sold-out');
            charmEl.style.opacity = '1'; // Keep full opacity in gallery
            const soldOutLabel = document.createElement('div');
            soldOutLabel.className = 'sold-out-label';
            soldOutLabel.textContent = 'Sold Out';
            charmEl.appendChild(soldOutLabel);
          }
          
          rareCharmsGrid.appendChild(charmEl);
        });
      }

      // Modified createCharm function for sold-out handling
      function createCharm(src, alt, type) {
        const charm = document.createElement('img');
        charm.className = 'charm';
        charm.src = src;
        charm.alt = alt;
        charm.dataset.type = type;
        
        charm.addEventListener('click', function() {
          if (this.classList.contains('sold-out')) {
            // Only fade out when in bracelet, not in gallery
            const inBracelet = this.parentElement.classList.contains('slot');
            if (inBracelet) {
              this.style.opacity = '0.5';
            }
            alert('This charm is sold out!');
            return;
          }
          
          document.querySelectorAll('.charm').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          selectedCharm = this;
        });
        
        return charm;
      }

      // [Rest of the code remains exactly the same]
    });
  </script>
</body>
</html>
